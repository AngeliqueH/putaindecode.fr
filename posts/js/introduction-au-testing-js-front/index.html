<!DOCTYPE html><html lang="fr"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width, init-scale=1.0, minimal-ui"><title>Introduction au testing js front</title><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@putaindecode"/><meta name="twitter:title" content="Introduction au testing js front"/><meta name="twitter:creator" content="@bloodyowl"/><meta name="twitter:image" content="http://www.gravatar.com/avatar/37500337ba5d2aebc962959ed83928e5.png?s=200"/><meta property="og:title" content="Introduction au testing js front"/><meta property="og:type" content="article"/><meta property="og:image" content="http://www.gravatar.com/avatar/37500337ba5d2aebc962959ed83928e5.png?s=200"/><meta property="og:site_name" content="Putain de code !"/><link rel="stylesheet" href="../../../stylesheets/index.css"></head><body><div class="putainde-Header"><div class="Grid"><div class="Grid-cell u-size7of12"><a href="../../.." class="putainde-SiteTitle"><img alt="Putain de code !" src="../../../images/p!-logo.svg" class="putainde-Logo"><span>Putain de code !</span></a></div><div class="Grid-cell u-size5of12"><nav class="putainde-Nav"><a href="../.." class="putainde-Nav-item">Les articles</a><a href="../../comment-contribuer" class="putainde-Nav-item">Contribuer</a><a href="irc://irc.freenode.net/putaindecode" class="putainde-Nav-item">IRC</a></nav></div></div></div><div class="putainde-Main"><article class="Grid putainde-Post"><div class="Grid-cell u-size8of12 Grid putainde-Post-contents"><div class="putainde-Title"><h1 class="putainde-Title-text">Introduction au testing js front</h1></div><header class="putainde-Post-header"><div class="putainde-Post-metas">Écrit par <a href="http://github.com/bloodyowl">bloodyowl</a>,<span class="putainde-Date"> le 1 mai 2014</span>. <span data-tip="Temps de lecture approximatif, sur une base de {{wpm}} mots par minute" data-readingTime-wpm="250" class="putainde-Post-readingTime putainde-Post-readingTime--hidden AttrTip AttrTip--top">Temps de lecture : environ  <span class="putainde-Post-readingTime-value"></span> minutes</span></div><ul class="putainde-Tags putainde-Post-tags"><li class="putainde-Tag">javascript</li><li class="putainde-Tag">tape</li><li class="putainde-Tag">unit-test</li><li class="putainde-Tag">browserify</li></ul></header><div class="putainde-Post-md"><p>Les tests automatisés en front-end ont longtemps été ignorés,
et le sont encore trop.</p>
<p>Écrire des tests peut paraître chiant, mais le temps qu’ils rapportent
compense largement celui que l’on passe à les écrire.</p>
<h2 id="ecrire-du-js-testable"><a class="putainde-Title-anchor" href="#ecrire-du-js-testable">#</a>Écrire du js testable</h2><p>Prenons un exemple simple et moche :</p>
<pre><code class="lang-javascript"><span class="hljs-comment">//app.js</span>
;(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>

  <span class="hljs-keyword">var</span> cart = $(<span class="hljs-string">"#cart"</span>)
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addToCart</span><span class="hljs-params">(id)</span>{</span>
    <span class="hljs-keyword">var</span> element = $(<span class="hljs-string">"&lt;li&gt;&lt;/li&gt;"</span>)
    element.html(catalog[id])
    cart.append(element)
  }

  $(<span class="hljs-string">".js-updateCart"</span>)
    .on(<span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventObject)</span>{</span>
      addToCart($(<span class="hljs-keyword">this</span>).data(<span class="hljs-string">"id"</span>))
    })

})()
</code></pre>
<p>Tester ce code est particulièrement lourd, pour plusieurs raisons :</p>
<ul>
<li>les functions à tester ne sont pas accessibles</li>
<li>on doit simuler un <code>click</code> pour tester un comportement logique.</li>
<li>on doit créer un element et modifier sont <code>data-id</code> à chaque cas souhaité.</li>
<li>pour tester <code>addToCart</code> on doit aller regarder dans le DOM.</li>
</ul>
<h3 id="1-rendez-accessibles-vos-methodes-au-test-runner"><a class="putainde-Title-anchor" href="#1-rendez-accessibles-vos-methodes-au-test-runner">#</a>1. Rendez accessibles vos méthodes au test runner</h3><p>Vous pouvez utiliser un namespace adéquat.</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> app = window.app = {}
app.cart = {}
app.cart.addToCart = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span> <span class="hljs-comment">/* … */</span> }
</code></pre>
<p>Mais ne souhaitez probablement pas rendre vos méthodes accessibles à la console.</p>
<p>Utilisez un module-system : <a href="http://browserify.org">browserify</a> ou
<a href="http://requirejs.org">requirejs</a> (si vous n’avez pas besoin de chargement
conditionnel et souhaitez créer un bundle par build, utilisez browserify qui
possède une syntaxe beaucoup plus sympathique et une codebase réduite, vous
pourrez même <code>require</code> depuis un module npm
<a href="/posts/js/browserify-all-the-things/">comme on vous l’explique dans un article dédié</a>).</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> $ = <span class="hljs-built_in">require</span>(<span class="hljs-string">"jquery"</span>) <span class="hljs-comment">// oh, un module npm</span>

module.exports = {
  element : $(<span class="hljs-string">"#cart"</span>),
  addToCart : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-comment">/* … */</span>
  }
}
</code></pre>
<p>Vous pourrez ainsi séparer proprement votre application en modules et les tester individuellement.</p>
<h3 id="2-oui-mais-les-modules-interdependants-alors-"><a class="putainde-Title-anchor" href="#2-oui-mais-les-modules-interdependants-alors-">#</a>2. Oui, mais les modules interdépendants alors ?</h3><p>Là, ça devient un peu plus tricky.
Ce que je conseille à titre personnel c’est d’utiliser des events
pour faire communiquer les différentes parties de l’application.</p>
<p>Cela permet d’éviter d’utiliser des mocks d’autres parties de l’application partout.</p>
<p>Par exemple, si je souhaite tester le fait qu’un click sur <code>.js-updateCart</code>
déclanchera bien <code>updateCart</code> :</p>
<pre><code class="lang-javascript"><span class="hljs-comment">//view.js</span>

<span class="hljs-comment">// view est une petite class qui route les events</span>
<span class="hljs-comment">// en rendant les listeners accessibles aux tests</span>
<span class="hljs-comment">// vous pouvez très facilement en concevoir une</span>
<span class="hljs-comment">// à votre goût en quelques lignes de code</span>
<span class="hljs-keyword">var</span> view = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../lib/view"</span>)

<span class="hljs-comment">// eventbus est l'event bus de l'application, il orchestre</span>
<span class="hljs-comment">// la communication entre les différents modules</span>
<span class="hljs-keyword">var</span> eventbus = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../eventbus"</span>)

<span class="hljs-keyword">var</span> $ = <span class="hljs-built_in">require</span>(<span class="hljs-string">"jquery"</span>)

module.exports = view.extend({
  element : document.body,
  events : [
    {
      type : <span class="hljs-string">"click"</span>,
      selector : <span class="hljs-string">".js-addToCart"</span>,
      listener : <span class="hljs-string">"addToCart"</span>
    }
  ],
  addToCart : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventObject)</span>{</span>
    <span class="hljs-keyword">var</span> target = eventObject.currentTarget
    <span class="hljs-keyword">var</span> id = $(target).data(<span class="hljs-string">"id"</span>)
    eventbus.fire(<span class="hljs-string">"addToCart"</span>, {
      id : id
    })
  }
})
</code></pre>
<p>et je n’aurais qu’à écouter cet event depuis <code>cart</code> :</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// cart.js</span>
<span class="hljs-keyword">var</span> eventbus = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../eventbus"</span>)
<span class="hljs-keyword">var</span> catalog = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../catalog"</span>)

module.exports = {
  initialize : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>._addToCart = <span class="hljs-keyword">this</span>.addToCart.bind(<span class="hljs-keyword">this</span>)
    eventbus.listen(<span class="hljs-string">"addToCart"</span>, <span class="hljs-keyword">this</span>._addToCart)
  },
  release : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    eventbus.stopListening(<span class="hljs-string">"addToCart"</span>, <span class="hljs-keyword">this</span>._addToCart)
  },
  addToCart : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventObject)</span>{</span>
    <span class="hljs-comment">// et on a eventObject.id</span>
    <span class="hljs-keyword">this</span>.products.push(catalog[eventObject.currentTarget.data(<span class="hljs-string">"id"</span>)])
  }
}
</code></pre>
<p>Grâce à cette architecture, je vais pouvoir tester individuellement
les deux modules.</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// view.test.js</span>

<span class="hljs-keyword">var</span> tape = <span class="hljs-built_in">require</span>(<span class="hljs-string">"tape"</span>)
<span class="hljs-keyword">var</span> view = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../app/view"</span>)
<span class="hljs-keyword">var</span> eventbus = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../eventbus"</span>)
<span class="hljs-keyword">var</span> $ = <span class="hljs-built_in">require</span>(<span class="hljs-string">"jquery"</span>)

tape(<span class="hljs-string">"view"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(test)</span>{</span>
  test.plan(<span class="hljs-number">1</span>)
  <span class="hljs-keyword">var</span> element = $(<span class="hljs-string">"&lt;div&gt;&lt;/div&gt;"</span>)
  element.data(<span class="hljs-string">"id"</span>, <span class="hljs-number">1</span>)
  <span class="hljs-comment">// on teste facilement l'envoi</span>
  eventbus.listen(<span class="hljs-string">"addToCart"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventObject)</span>{</span>
    test.equal(eventObject.id, <span class="hljs-number">1</span>)
  })
  view.addToCart({
    currentTarget : element
  })
})
</code></pre>
<pre><code class="lang-javascript"><span class="hljs-comment">// cart.test.js</span>

<span class="hljs-keyword">var</span> tape = <span class="hljs-built_in">require</span>(<span class="hljs-string">"tape"</span>)
<span class="hljs-keyword">var</span> cart = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../app/cart"</span>)
<span class="hljs-keyword">var</span> eventbus = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../eventbus"</span>)
<span class="hljs-keyword">var</span> catalog = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../catalog"</span>)

tape(<span class="hljs-string">"cart"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(test)</span>{</span>
  cart.initialize()
  eventbus.fireSync(<span class="hljs-string">"addToCart"</span>, {id:<span class="hljs-number">1</span>})
  test.deepEqual(
    cart[<span class="hljs-number">0</span>],
    catalog[<span class="hljs-number">1</span>],
    <span class="hljs-string">"receives addToCart event"</span>
  )
  test.end()
})
</code></pre>
<h2 id="tester-tous-les-cas-possibles"><a class="putainde-Title-anchor" href="#tester-tous-les-cas-possibles">#</a>Tester tous les cas possibles</h2><p>Ce sont souvent les edge-cases qui nous font nous arracher les cheveux.
Pour pallier ces soucis, tester en profondeur est essentiel.</p>
<p>Prenons un exemple, une méthode qui teste si la valeur qu’on lui passe est
une <code>string</code>.</p>
<p>On serait tenté de simplement tester les résultats positifs de cette façon :</p>
<pre><code class="lang-javascript">tape(<span class="hljs-string">"type.isString on strings"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(test)</span></span>{
  test.equal(<span class="hljs-built_in">type</span>.isString(<span class="hljs-string">""</span>), <span class="hljs-keyword">true</span>)
  test.<span class="hljs-keyword">end</span>()
})
</code></pre>
<p>Or, si par mégarde ma méthode <code>isString</code> se révèle être :</p>
<pre><code class="lang-javascript">type.isString = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> {</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">"string"</span>
}
</code></pre>
<p>on ne vérifie pas le cas <code>type.isString(new String(&quot;&quot;))</code>.</p>
<p>Du coup, des tests complets :</p>
<pre><code class="lang-javascript">tape(<span class="hljs-string">"type.isString on strings"</span>, <span class="hljs-keyword">function</span>(test){
  test.equal(<span class="hljs-class"><span class="hljs-keyword">type</span>.<span class="hljs-title">isString</span>(</span><span class="hljs-string">""</span>), <span class="hljs-keyword">true</span>)
  test.equal(<span class="hljs-class"><span class="hljs-keyword">type</span>.<span class="hljs-title">isString</span>(</span><span class="hljs-keyword">new</span> String(<span class="hljs-string">""</span>)), <span class="hljs-keyword">false</span>)
  test.<span class="hljs-keyword">end</span>()
})
</code></pre>
<p>permettent ici d’identifier qu’en réalité on a besoin de :</p>
<pre><code class="lang-javascript">type.isString = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> {</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.prototype.toString.call(value) == <span class="hljs-string">"[object String]"</span>
}
</code></pre>
<p>Et c’est à la force des résultats de tests que vous identifierez rapidement
vous familiariserez à tous ces edge-cases.</p>
<p>À chaque correctif de bug, ajoutez des tests (mais ça, vous le saviez déjà).</p>
<h2 id="cross-browser-testing"><a class="putainde-Title-anchor" href="#cross-browser-testing">#</a>Cross-browser testing</h2><p>À l’heure actuelle, où l’on se trouve notamment très souvent avec du
feature testing.
Pour le tester complètement, on doit se servir de vrais navigateurs :
un headless (certes, très pratique) comme <a href="http://phantomjs.org">phantomjs</a>
ne permettra pas d’obtenir 100% de coverage.</p>
<pre><code class="lang-javascript">var supportsAnimationFrame =
  !!(
    win.requestAnimationFrame <span class="hljs-string">||</span>
    win.webkitRequestAnimationFrame <span class="hljs-string">||</span>
    win.mozRequestAnimationFrame <span class="hljs-string">||</span>
    win.ORequestAnimationFrame <span class="hljs-string">||</span>
    <span class="hljs-comment">// vous avez fait une faute de frappe,</span>
    <span class="hljs-comment">// et mis un `O` majuscule, seul un</span>
    <span class="hljs-comment">// test sur les version concernées d'Opera</span>
    <span class="hljs-comment">// vous permettront de l'identifier</span>
    win.msRequestAnimationFrame
  )
</code></pre>
<p>De plus, vous pouvez par habitude être tenté d’utiliser un
<code>Array.prototype.forEach</code> alors que votre scope navigateur inclut
IE8; seuls des tests sur un vrai browser vous permettront d’identifier le souci.</p>
<p>Je vous conseille fortement testling, très simple à intégrer dans vos
modules, et gratuit pour tout projet open-source.</p>
<p>Dans le <code>package.json</code> :</p>
<pre><code class="lang-json">{
  "<span class="hljs-attribute">testling</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">files</span>": <span class="hljs-value"><span class="hljs-string">"test/**/*.js"</span></span>,
    "<span class="hljs-attribute">browsers</span>": <span class="hljs-value">[
      <span class="hljs-string">"ie/9..latest"</span>,
      <span class="hljs-string">"chrome/22..latest"</span>,
      <span class="hljs-string">"firefox/16..latest"</span>,
      <span class="hljs-string">"safari/6..latest"</span>,
      <span class="hljs-string">"opera/11.0..latest"</span>,
      <span class="hljs-string">"iphone/6..latest"</span>,
      <span class="hljs-string">"ipad/6..latest"</span>,
      <span class="hljs-string">"android-browser/latest"</span>
    ]
  </span>}
</span>}
</code></pre>
<p>Et ajouter un webhook dans l’admin de votre repository GitHub pointant vers</p>
<blockquote>
<p><a href="http://git.testling.com">http://git.testling.com</a></p>
</blockquote>
<p>Vous pouvez l’utiliser avec tape (son test harness par défaut)
Mocha, QUnit et n’importe quelle bibliothèque
de test supportant <code>TAP</code> comme indiqué sur
<a href="https://ci.testling.com/guide/custom_libraries">le site de testling</a>.</p>
<p>Vous trouverez aussi des alternatives populaires
<a href="http://www.browserstack.com">similaires</a>,
ou ayant <a href="http://karma-runner.github.io">une approche différente</a>.</p>
<p>Par ailleurs, si dans votre code il existe des variations entre les navigateurs,
vous pouvez utiliser du test conditionnel :</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">if</span>(typeof {}.__proto__ == <span class="hljs-string">"object"</span>){
  test.equal(<span class="hljs-keyword">list</span>.__proto__ === <span class="hljs-keyword">Array</span>.prototype, <span class="hljs-keyword">false</span>, <span class="hljs-string">"__proto__ isn't Array.prototype"</span>)
} <span class="hljs-keyword">else</span> {
  test.equal(<span class="hljs-keyword">list</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">Array</span>, <span class="hljs-keyword">false</span>, <span class="hljs-string">"Isn't a window Array"</span>)
}
</code></pre>
<p>Happy testing!</p>
<pre><code class="lang-shell">$ testling

TAP version <span class="hljs-number">13</span>
<span class="hljs-preprocessor"># tests</span>
ok <span class="hljs-number">1</span> bisous

<span class="hljs-number">1.</span><span class="hljs-number">.1</span>
<span class="hljs-preprocessor"># tests 1</span>
<span class="hljs-preprocessor"># pass  1</span>

<span class="hljs-preprocessor"># ok</span>
</code></pre>
</div><footer class="putainde-Post-footer"><div class="putainde-Post-footer-title">Action sur cette page</div><div class="Grid"><div class="Grid-cell u-size1of3"><a href="https://github.com/putaindecode/website/edit/master/pages/posts/js/introduction-au-testing-js-front/index.md" class="putainde-Post-footer-action">Modifier</a></div><div class="Grid-cell u-size1of3"><a href="https://github.com/putaindecode/website/blame/master/pages/posts/js/introduction-au-testing-js-front/index.md" class="putainde-Post-footer-action">Tracer les changements</a></div><div class="Grid-cell u-size1of3"><a href="https://github.com/putaindecode/website/commits/master/pages/posts/js/introduction-au-testing-js-front/index.md" class="putainde-Post-footer-action">Historique</a></div></div></footer><div class="putainde-Author putainde-Author--author"><img src="http://www.gravatar.com/avatar/37500337ba5d2aebc962959ed83928e5.png" alt="" class="putainde-Author-picture putainde-Avatar js-AnimateLoad"/><div class="putainde-Author-description"><div class="putainde-Author-title"><h3 class="putainde-Author-name"><span class="putainde-WrittenBy">Écrit par</span> bloodyowl</h3><div class="putainde-Author-social"><a href="http://bloodyowl.io"><i class="putainde-Icon putainde-Icon--world"></i></a><a href="https://twitter.com/bloodyowl"><i class="putainde-Icon putainde-Icon--twitter"></i></a><a href="https://github.com/bloodyowl"><i class="putainde-Icon putainde-Icon--github"></i></a></div></div><p>Développeur front-end, aime la bonne bière artisanale, la musique, et JavaScript; n'aime ni les points virgules, ni les gens</p></div></div><div class="putainde-Contributors"><strong class="putainde-Contributors-label">3 contributeurs</strong><a href="https://github.com/bloodyowl" data-tip="bloodyowl" class="putainde-Contributor AttrTip AttrTip--bottom"><img src="http://www.gravatar.com/avatar/37500337ba5d2aebc962959ed83928e5.png" alt="" class="putainde-Contributor-avatar putainde-Avatar js-AnimateLoad"/></a><a href="https://github.com/MoOx" data-tip="MoOx" class="putainde-Contributor AttrTip AttrTip--bottom"><img src="http://www.gravatar.com/avatar/2f6c2dcd4ba8fc44f1e7f0b2ed3d587d.png" alt="" class="putainde-Contributor-avatar putainde-Avatar js-AnimateLoad"/></a><a href="https://github.com/lionelB" data-tip="lionelB" class="putainde-Contributor AttrTip AttrTip--bottom"><img src="http://www.gravatar.com/avatar/03edc8b4edc19d91202e69c65c5baeff.png" alt="" class="putainde-Contributor-avatar putainde-Avatar js-AnimateLoad"/></a></div><div id="disqus_thread" aria-live="polite"><noscript>| Please enable JavaScript to view the
a(href="http://disqus.com/?ref_noscript") comments powered by Disqus.</noscript></div></div></article></div><div class="putainde-Footer"><div class="Grid"><div class="Grid-cell u-size4of12"><p class="putainde-Footer-text">© 1970 - 2014 Putain de Code !</p></div><div class="Grid-cell u-size4of12"><ul class="putainde-Footer-list"><li><a href="../../../projets">Projets</a></li><li><a href="https://github.com/putaindecode">Contact</a></li><li><a href="../../../feed.xml">Flux RSS</a></li><li><a href="../../../c-est-quoi-putaindecode">Putain de ?</a></li><li><a href="https://github.com/putaindecode/forum/issues">Forum</a></li></ul></div><div class="Grid-cell u-size4of12"><p class="putainde-Footer-text putainde-Footer-text--small putainde-Footer-text--right">Made with ♥︎ by <a href="../../../#crew">le crew</a></p></div></div></div><script>var disqus_shortname = "putaindecode";var disqus_identifier = "http://putaindecode.fr/posts/js/introduction-au-testing-js-front/";
var disqus_url = "http://putaindecode.fr/posts/js/introduction-au-testing-js-front/";
var disqus_script = "embed.js";;(function(d,s) {
s = d.createElement('script');s.async=1;s.src = '//' + disqus_shortname + '.disqus.com/'+disqus_script;
(d.getElementsByTagName('head')[0]).appendChild(s)
})(document)</script><script src="../../../scripts/index.js"></script><script>var _gaq=[['_setAccount','UA-43771806-1'],['_trackPageview']];
(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
g.src='//www.google-analytics.com/ga.js';
s.parentNode.insertBefore(g,s)}(document,'script'));</script></body></html>