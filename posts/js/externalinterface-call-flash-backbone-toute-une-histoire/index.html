<!DOCTYPE html><html lang="fr"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width, init-scale=1.0, minimal-ui"><title>ExternalInterface.call() de Flash (et Backbone), toute une histoire</title><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@putaindecode"/><meta name="twitter:title" content="ExternalInterface.call() de Flash (et Backbone), toute une histoire"/><meta name="twitter:creator" content="@_kud"/><meta name="twitter:image" content="http://www.gravatar.com/avatar/9713e529bef70eea8965e0dda2000334.png?s=200"/><meta property="og:title" content="ExternalInterface.call() de Flash (et Backbone), toute une histoire"/><meta property="og:type" content="article"/><meta property="og:image" content="http://www.gravatar.com/avatar/9713e529bef70eea8965e0dda2000334.png?s=200"/><meta property="og:site_name" content="Putain de code !"/><link rel="stylesheet" href="../../../stylesheets/index.css"><link rel="alternate" href="../../../feed.xml" title="Putain de code !" type="application/atom+xml"></head><body><div class="putainde-Header"><div class="Grid"><div class="Grid-cell u-size5of12"><a href="../../.." class="putainde-SiteTitle"><img alt="Putain de code !" src="../../../images/p!-logo.svg" class="putainde-Logo"><span>Putain de code !</span></a></div><div class="Grid-cell u-size7of12"><nav class="putainde-Nav"><a href="../.." data-tip="" class="putainde-Nav-item  "><i class="putainde-Icon putainde-Icon--bookmark"></i> Articles</a><a href="../../../c-est-quoi-putaindecode" data-tip="" class="putainde-Nav-item  "><i class="putainde-Icon putainde-Icon--text-file"></i> Readme</a><a href="../../comment-contribuer" data-tip="" class="putainde-Nav-item  "><i class="putainde-Icon putainde-Icon--pencil"></i> Participer</a><a href="https://github.com/putaindecode/" data-tip="GitHub" class="putainde-Nav-item  putainde-Nav-item--icon AttrTip AttrTip--bottom"><i class="putainde-Icon putainde-Icon--github"></i></a><a href="https://twitter.com/putaindecode/" data-tip="Twitter" class="putainde-Nav-item  putainde-Nav-item--icon AttrTip AttrTip--bottom"><i class="putainde-Icon putainde-Icon--twitter"></i></a></nav></div></div></div><div class="putainde-Main"><article class="Grid putainde-Post"><div class="Grid-cell u-size8of12 Grid putainde-Post-contents"><div class="putainde-Title"><h1 class="putainde-Title-text">ExternalInterface.call() de Flash (et Backbone), toute une histoire</h1></div><header class="putainde-Post-header"><div class="putainde-Post-metas">Écrit par <a href="https://github.com/kud">kud</a>,<span class="putainde-Date"> le 5 déc. 2013</span>. <span data-tip="Temps de lecture approximatif, sur une base de {{wpm}} mots par minute" data-readingTime-wpm="250" class="putainde-Post-readingTime putainde-Post-readingTime--hidden AttrTip AttrTip--top">Temps de lecture : environ  <span class="putainde-Post-readingTime-value"></span> minutes</span></div><ul class="putainde-Tags putainde-Post-tags"><li class="putainde-Tag">javascript</li><li class="putainde-Tag">backbone</li><li class="putainde-Tag">flash</li></ul></header><div class="putainde-Post-md"><figure class="putainde-Media putainde-Media--left"><img src="../../../images/posts/occupyflash.png" alt=""></figure>

<p>Je voulais vous parler d’un bug qui m’a bien emmerdé récemment et comme j’aimerais que vous ne perdiez pas de temps avec cela, un article s’imposait.</p>
<p><em>Note de la direction : j’y connais rien en Flash (et je ne crois pas avoir trop envie de connaître en fait).</em></p>
<p>Dans la boite où je travaille, nous utilisons Flash en tant que lecteur vidéo étant donné qu’il est pour le moment très difficile de faire lire sur toutes les plateformes des vidéos au format <em>H.264</em> et/ou passant par du <em>HLS</em>. Longue histoire qui fera office d’un autre article. (Je dis ça à chaque fois, haha).</p>
<h2 id="le-pitch"><a class="putainde-Title-anchor" href="#le-pitch">#</a>Le pitch</h2><p>Avec notre <em>flasheur</em> attitré, nous nous sommes mis en tête de créer un objet <em>event</em> qui permettrait au Flash de déclencher des évènements lorsqu’il le souhaite afin de communiquer avec l’application JavaScript et que celui-ci fasse en conséquence. Cet objet, nous l’avons appelé <code>App.FlashManager</code> et plus précisemment <code>App.FlashManager.Events</code> dans le cas des évènements. Nous utilisons <strong>Backbone.js</strong> pour gérer ce principe d’évènement mais vous en avez d’<a href="http://microjs.com/#event">autres</a> de disponible. En pratique, voilà ce que ça donne :</p>
<pre><code class="lang-javascript"> <span class="hljs-comment">// on crée un objet vide</span>
<span class="hljs-constant">App.FlashManager.Events</span> = {}

<span class="hljs-comment">// on lui ajoute les fonctionnalités des events Backbone</span>
<span class="hljs-constant">_.extend(App.FlashManager.Events, Backbone.Events)</span>
</code></pre>
<p>En soi, pas de souci, tout se passe bien à ce moment, nous avons un <a href="http://backbonejs.org/#Events">objet d’évènement façon Backbone</a>. Il pourra alors s’écouter lui-même, écouter un autre objet, mais aussi déclencher des évènements.</p>
<h2 id="cote-flash"><a class="putainde-Title-anchor" href="#cote-flash">#</a>Côté Flash</h2><p>La base est en place, maintenant on souhaite que le Flash déclenche un évènement. On passe par l’objet <code>ExternalInterface</code> :</p>
<pre><code class="lang-javascript"><span class="hljs-constant">ExternalInterface</span>.call(<span class="hljs-string">"window.App.FlashManager.Events.trigger"</span>, <span class="hljs-string">"my-event"</span>)
/<span class="hljs-regexp">/ http:/</span><span class="hljs-regexp">/help.adobe.com/en</span>_US/<span class="hljs-constant">FlashPlatform</span>/reference/actionscript/<span class="hljs-number">3</span>/flash/external/<span class="hljs-constant">ExternalInterface</span>.html<span class="hljs-comment">#call</span>
</code></pre>
<p>Et là, bug.</p>
<h2 id="pourquoi-bug-"><a class="putainde-Title-anchor" href="#pourquoi-bug-">#</a>Pourquoi bug ?</h2><p>Pour le moment, je ne sais pas vraiment. Je me pencherai plus sur le sujet dès que j’ai un peu de temps, mais ce que je sais, c’est que <code>ExtercalInterface.call()</code> ne s’attend pas à recevoir ce que <strong>Backbone.js</strong> lui propose. Lorsque vous faites <code>.trigger()</code>, <strong>Backbone.js</strong> renvoie l’<a href="https://github.com/jashkenas/backbone/blob/master/backbone.js#L144-L153">objet en cours</a>, ce qui provoque un énooooorme bug dans le plugin Flash de votre navigateur.</p>
<h2 id="la-solution-cote-javascript"><a class="putainde-Title-anchor" href="#la-solution-cote-javascript">#</a>La solution côté JavaScript</h2><p>Pour contrer cela, je vous propose la solution suivante qui est de ne pas utiliser directement l’objet <code>Backbone.Events|View</code> mais plutôt de passer par une interface, un objet proxy.</p>
<p>Voici le schéma :</p>
<ul>
<li>Créer un objet simple qui contient les mêmes noms de méthodes que les objets évènements <strong>Backbone.js</strong> (en gros, se mapper sur l’API Backbone)</li>
<li>Utiliser <strong>Backbone.js</strong> dans les méthodes de cet objet <em>Proxy</em></li>
</ul>
<p>Exemple :</p>
<pre><code class="lang-javascript">// Bridge between flash <span class="hljs-keyword">and</span> js
App.FlashManager = {}
App.FlashManager.Events = {}

// Backbone events used <span class="hljs-keyword">for</span> Flash
App.InternalFlashManager = {}
App.InternalFlashManager.Events = {}

_.extend(App.InternalFlashManager.Events, Backbone.Events)

App.FlashManager.Events.trigger = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, opts)</span></span> {
    App.InternalFlashManager.Events.trigger(name, opts)

    // Must <span class="hljs-keyword">return</span> nothing <span class="hljs-keyword">not</span> to loop JavaScript engine, important!
    <span class="hljs-keyword">return</span>
}
</code></pre>
<h2 id="oh-et-"><a class="putainde-Title-anchor" href="#oh-et-">#</a>Oh et…</h2><p>…il existe une version ayant plus ou moins le même souci que moi disponible là : <a href="https://coderwall.com/p/e-8niw">ExternalInterface#call in a deadly loop (<strong>flash</strong>toXML)</a>.</p>
<h2 id="conclusion"><a class="putainde-Title-anchor" href="#conclusion">#</a>Conclusion</h2><p>De manière générale (hors <strong>Backbone.js</strong>), lorsque vous utilisez <code>ExtercalInterface.call()</code>, faites en sorte que votre JavaScript retourne quelque chose de simple (un objet ayant que des atributs, pas de fonctions, ou encore un bouléen ou un <em>integer</em>).</p>
</div><footer class="putainde-Post-footer"><div class="putainde-Post-footer-title">Action sur cette page</div><div class="Grid"><div class="Grid-cell u-size1of3"><a href="https://github.com/putaindecode/website/edit/master/pages/posts/js/externalinterface-call-flash-backbone-toute-une-histoire/index.md" class="putainde-Post-footer-action">Modifier</a></div><div class="Grid-cell u-size1of3"><a href="https://github.com/putaindecode/website/blame/master/pages/posts/js/externalinterface-call-flash-backbone-toute-une-histoire/index.md" class="putainde-Post-footer-action">Tracer les changements</a></div><div class="Grid-cell u-size1of3"><a href="https://github.com/putaindecode/website/commits/master/pages/posts/js/externalinterface-call-flash-backbone-toute-une-histoire/index.md" class="putainde-Post-footer-action">Historique</a></div></div></footer><div class="putainde-Author putainde-Author--author"><a href="https://github.com/kud" data-tip="kud" class="putainde-Author-picture "><img src="http://www.gravatar.com/avatar/9713e529bef70eea8965e0dda2000334.png" alt="" class="putainde-Avatar js-AnimateLoad"/></a><div class="putainde-Author-description"><div class="putainde-Author-title"><h3 class="putainde-Author-name"><span class="putainde-WrittenBy">Écrit par</span> kud</h3><div class="putainde-Author-social"><a href="http://kud.io"><i class="putainde-Icon putainde-Icon--world"></i></a><a href="https://twitter.com/_kud"><i class="putainde-Icon putainde-Icon--twitter"></i></a><a href="https://github.com/kud"><i class="putainde-Icon putainde-Icon--github"></i></a></div></div><p>Viking UI engineer (avec une pointe de node.js), batteur, s'essayant à la photographie, aime le cinema.</p></div></div><div class="putainde-Contributors"><strong class="putainde-Contributors-label">3 contributeurs</strong><a href="https://github.com/MoOx" data-tip="MoOx" class="putainde-Contributor AttrTip AttrTip--bottom"><img src="http://www.gravatar.com/avatar/2f6c2dcd4ba8fc44f1e7f0b2ed3d587d.png" alt="" class="putainde-Avatar js-AnimateLoad"/></a><a href="https://github.com/kud" data-tip="kud" class="putainde-Contributor AttrTip AttrTip--bottom"><img src="http://www.gravatar.com/avatar/9713e529bef70eea8965e0dda2000334.png" alt="" class="putainde-Avatar js-AnimateLoad"/></a><a href="https://github.com/bloodyowl" data-tip="bloodyowl" class="putainde-Contributor AttrTip AttrTip--bottom"><img src="http://www.gravatar.com/avatar/37500337ba5d2aebc962959ed83928e5.png" alt="" class="putainde-Avatar js-AnimateLoad"/></a></div><div id="disqus_thread" aria-live="polite"><noscript>| Please enable JavaScript to view the
a(href="http://disqus.com/?ref_noscript") comments powered by Disqus.</noscript></div></div></article></div><div class="putainde-Footer"><div class="Grid"><div class="Grid-cell u-size3of12"><p class="putainde-Footer-text">© 1970 - 2014 Putain de Code !</p></div><div class="Grid-cell u-size6of12"><ul class="putainde-Footer-list"><li></li><li><a href="../../../feed.xml">Flux RSS</a></li><li><a href="../../../projets">Projets</a></li><li><a href="https://github.com/putaindecode/forum/issues">Forum</a></li><li><a href="irc://irc.freenode.net/putaindecode">IRC</a></li><a href="https://github.com/putaindecode/" data-tip="GitHub" class="AttrTip AttrTip--top"><i class="putainde-Icon putainde-Icon--github"></i></a><a href="https://twitter.com/putaindecode/" data-tip="Twitter" class="AttrTip AttrTip--top"><i class="putainde-Icon putainde-Icon--twitter"></i></a></ul></div><div class="Grid-cell u-size3of12"><p class="putainde-Footer-text putainde-Footer-text--small putainde-Footer-text--right">Made with ♥︎ by <a href="../../../#crew">le crew</a></p></div></div></div><script>var disqus_shortname = "putaindecode";var disqus_identifier = "http://putaindecode.fr/posts/js/externalinterface-call-flash-backbone-toute-une-histoire/";
var disqus_url = "http://putaindecode.fr/posts/js/externalinterface-call-flash-backbone-toute-une-histoire/";
var disqus_script = "embed.js";;(function(d,s) {
s = d.createElement('script');s.async=1;s.src = '//' + disqus_shortname + '.disqus.com/'+disqus_script;
(d.getElementsByTagName('head')[0]).appendChild(s)
})(document)</script><script src="../../../scripts/index.js"></script><script>var _gaq=[['_setAccount','UA-43771806-1'],['_trackPageview']];
(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
g.src='//www.google-analytics.com/ga.js';
s.parentNode.insertBefore(g,s)}(document,'script'));</script></body></html>